<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Dinosaur Explorer â€” Timeline View</title>
<link rel="stylesheet" href="explorer-shared.css">
<script src="explorer-shared.js"></script>
<style>
canvas { width:100%; height:520px; border:1px solid var(--border); background:linear-gradient(180deg,#0d1535,#0b1230); border-radius:16px; display:block; }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>ðŸ§­ Dinosaur Explorer â€” Timeline View</h1>
    <div class="controls" style="grid-template-columns:1fr 0.8fr 1.2fr 1.2fr;">
      <div><label for="q">Search</label><input id="q" type="text"></div>
      <div><label for="diet">Diet</label>
        <select id="diet"><option value="">Any</option><option>herbivore</option><option>carnivore</option><option>omnivore</option></select>
      </div>
      <div><label for="clade">Clade</label><input id="clade" type="text"></div>
      <div><label for="year">Time (Mya)</label>
        <input id="year" type="range" min="230" max="66" step="1" value="100">
        <div><small id="yearLabel">100 Mya</small></div>
      </div>
    </div>
    <div id="status">Loadingâ€¦</div>
  </div>
</header>

<main class="wrap">
  <canvas id="timeline" width="1200" height="520"></canvas>
  <div id="legend" class="legend"></div>
  <div id="table" class="table"></div>
</main>

<script>
const q=document.getElementById('q'),diet=document.getElementById('diet'),clade=document.getElementById('clade'),year=document.getElementById('year'),yearLabel=document.getElementById('yearLabel');
const statusEl=document.getElementById('status'),canvas=document.getElementById('timeline'),ctx=canvas.getContext('2d');

const PAD={left:80,right:20,top:20,bottom:40};
const MIN=230,MAX=66;
function xScale(mya){const w=canvas.width-PAD.left-PAD.right;const t=(mya-MIN)/(MAX-MIN);return PAD.left+t*w;}

let rows=[];
function useCSVText(text){
  const need=["genus","clade","time_period","age_range_mya","regions","diet","status","page_url","image_url"];
  const {ok,rows:raw}=Explorer.csvToRows(text,need); 
  if(!ok){statusEl.textContent="CSV missing headers.";return;}
  rows=raw.map(r=>({...r,range:Explorer.parseRange(r.age_range_mya)})).filter(r=>r.range);
  statusEl.textContent=`Loaded ${rows.length} dinosaurs.`; draw();
}

function drawAxes(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.strokeStyle="#1a2550";ctx.lineWidth=1;
  for(let m=230;m>=66;m-=10){
    const x=xScale(m);ctx.beginPath();ctx.moveTo(x,PAD.top);ctx.lineTo(x,canvas.height-PAD.bottom);ctx.stroke();
  }
  ctx.fillStyle="#cfe0ff";ctx.font="12px system-ui,sans-serif";
  for(let m=230;m>=66;m-=20){
    const x=xScale(m);ctx.fillText(m+" Mya",x-18,canvas.height-PAD.bottom+16);
  }
  Explorer.Periods.forEach(({label,start,end})=>{
    const x1=xScale(start),x2=xScale(end);
    ctx.fillStyle="rgba(122,162,255,0.08)";
    ctx.fillRect(Math.min(x1,x2),PAD.top,Math.abs(x2-x1),canvas.height-PAD.top-PAD.bottom);
    ctx.fillStyle="#8ea0d8";
    ctx.fillText(label,(x1+x2)/2-ctx.measureText(label).width/2,PAD.top+14);
  });
}

function draw(){
  if(!rows.length){drawAxes();return;}
  const y=parseInt(year.value,10);yearLabel.textContent=y+" Mya";
  drawAxes();
  const xs=xScale(y);
  ctx.strokeStyle="#ffd166";ctx.lineWidth=2;
  ctx.beginPath();ctx.moveTo(xs,PAD.top);ctx.lineTo(xs,canvas.height-PAD.bottom);ctx.stroke();
  ctx.fillStyle="#ffd166";ctx.fillText(y+" Mya",xs-16,PAD.top+30);

  const needle=q.value.trim().toLowerCase(),wantDiet=diet.value.trim().toLowerCase(),wantClade=clade.value.trim().toLowerCase();
  const alive=rows.filter(r=>{
    if(needle && !(r.genus+" "+r.regions+" "+r.time_period).toLowerCase().includes(needle)) return false;
    if(wantDiet && (r.diet||'').toLowerCase()!=wantDiet) return false;
    if(wantClade && (r.clade||'').toLowerCase()!=wantClade) return false;
    return r.range.start>=y && r.range.end<=y;
  });

  alive.sort((a,b)=>a.clade.localeCompare(b.clade)||a.genus.localeCompare(b.genus));
  const rowH=18,startY=PAD.top+40;
  alive.forEach((r,i)=>{
    const ypix=startY+i*(rowH+4);
    const x1=xScale(r.range.start),x2=xScale(r.range.end);
    ctx.strokeStyle=Explorer.colorFor(r.clade);
    ctx.lineWidth=6;ctx.lineCap="round";
    ctx.beginPath();ctx.moveTo(x1,ypix);ctx.lineTo(x2,ypix);ctx.stroke();
    ctx.fillStyle="#eaf0ff";ctx.fillText(r.genus,x2+8,ypix+4);
  });

  document.getElementById('legend').innerHTML=[...new Set(alive.map(r=>r.clade))]
    .map(c=>`<span style="color:${Explorer.colorFor(c)};border-color:${Explorer.colorFor(c)}">${c}</span>`).join(" ");

  // Build table with thumbnail column and hydrate
  document.getElementById('table').innerHTML=
    `<div class="row head"><div></div><div>Genus</div><div class="hide-sm">Time Period</div><div>Age Range (Mya)</div><div class="hide-sm">Diet</div><div class="hide-sm">Region</div></div>`+
    alive.map((r,i)=>
      `<div class="row">
        <div><img id="thumb_${i}" alt="${r.genus}" width="44" height="32" style="border-radius:6px;object-fit:cover;display:block"></div>
        <div><a href="${r.page_url}" target="_blank">${r.genus}</a></div>
        <div class="hide-sm">${r.time_period}</div>
        <div>${r.age_range_mya}</div>
        <div class="hide-sm">${r.diet}</div>
        <div class="hide-sm">${r.regions}</div>
      </div>`
    ).join("");

  // Hydrate thumbnails
  alive.forEach(async (r,i)=>{
    const img=document.getElementById(`thumb_${i}`);
    if(!img) return;
    const SVG_PLACEHOLDER = 'data:image/svg+xml;utf8,'+encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 120 80"><defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop stop-color="#172448"/><stop offset="1" stop-color="#0b1330"/></linearGradient></defs><rect width="120" height="80" fill="url(#g)"/><g fill="#7aa2ff" opacity=".9"><path d="M8,62 Q45,35 72,48 Q87,55 112,53 Q99,62 86,64 Q69,66 52,62 Q35,58 18,66 Z"/></g></svg>`);
    img.src = SVG_PLACEHOLDER;
    img.referrerPolicy='no-referrer'; img.loading='lazy';
    try{ const withTimeout=(p,ms=6000)=>Promise.race([p,new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout')),ms))]);
      const url=await withTimeout(Explorer.resolvePaleoartImage(r));
      if(url) img.src=url;
    }catch{}
  });
}

[q,diet,clade].forEach(el=>el.addEventListener('input',draw));
year.addEventListener('input',draw);

// Auto-load CSV with fallbacks
(async function loadCSV(){
  const attempts=['dinosaurs_sample.csv','../output/dinosaurs_sample.csv'];
  for(const url of attempts){
    try{ const r=await fetch(url); if(r.ok){ useCSVText(await r.text()); return; } }catch{}
  }
  statusEl.textContent='No CSV found. Using demo data.';
  useCSVText(`genus,clade,time_period,age_range_mya,regions,diet,status,page_url,image_url
Tyrannosaurus,Theropod,Late Cretaceous,68â€“66 Mya,North America,carnivore,valid,https://en.wikipedia.org/wiki/Tyrannosaurus,
Triceratops,Ceratopsian,Late Cretaceous,68â€“66 Mya,North America,herbivore,valid,https://en.wikipedia.org/wiki/Triceratops,
Stegosaurus,Stegosaur,Late Jurassic,155â€“150 Mya,North America,herbivore,valid,https://en.wikipedia.org/wiki/Stegosaurus,
Velociraptor,Dromaeosaur,Late Cretaceous,75â€“71 Mya,Asia,carnivore,valid,https://en.wikipedia.org/wiki/Velociraptor,`);
})(); 
</script>
</body>
</html>
